name: Release

on:
  push:
    tags: ["v*"]

jobs:
  release:
    name: Build & Release
    runs-on: macos-14

    permissions:
      contents: write   # create GitHub Release + upload assets

    env:
      HAS_PYPI_TOKEN: ${{ secrets.PYPI_TOKEN != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Extract version from tag ──────────────────────────────
      - name: Extract version
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=$TAG"         >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # ── Swift + Dylib ─────────────────────────────────────────
      - name: Build Swift package (release)
        run: swift build -c release

      - name: Build dylib
        run: ./scripts/build_dylib.sh

      # ── Python wheel ──────────────────────────────────────────
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install build dependencies
        run: pip install build hatchling

      - name: Build wheel
        run: ./scripts/build_wheel.sh --no-swift

      - name: Verify wheel
        run: |
          WHEEL=$(ls dist/metalmom-*.whl | head -1)
          echo "Built: $WHEEL"
          unzip -l "$WHEEL" | grep -E "(dylib|\.h|METADATA)"

      # ── GitHub Release ────────────────────────────────────────
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          gh release create "$TAG" \
            --title "MetalMom $TAG" \
            --generate-notes \
            dist/metalmom-*.whl

      # ── PyPI (optional — requires PYPI_TOKEN secret) ──────────
      - name: Publish to PyPI
        if: env.HAS_PYPI_TOKEN == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
