# Releasing MetalMom

## Prerequisites

- `git-cliff` installed (`brew install git-cliff`)
- GitHub repo secrets configured:
  - `PYPI_TOKEN` — PyPI API token
  - `TEST_PYPI_TOKEN` — TestPyPI API token
- Clean working tree on `main` with CI green

## Release Candidate

```bash
# 1. Bump version and tag RC
./scripts/bump_version.sh 0.2.0 --rc 1

# 2. Push to trigger release workflow
git push origin main --tags

# 3. Verify
#    - GitHub pre-release created with wheel + XCFramework + .sigstore bundles
#    - TestPyPI: pip install -i https://test.pypi.org/simple/ metalmom==0.2.0rc1
#    - XCFramework zip + sha256 attached
```

## Final Release

```bash
# 1. Bump version and tag
./scripts/bump_version.sh 0.2.0

# 2. Push to trigger release workflow
git push origin main --tags

# 3. Verify
#    - GitHub Release created (not pre-release)
#    - PyPI: pip install metalmom==0.2.0
#    - XCFramework zip + sha256 attached
#    - Swift Package Index updated (may take up to 1 hour)

# 4. Verify sigstore signatures
pip install sigstore
python -m sigstore verify identity dist/metalmom-*.whl \
  --cert-oidc-issuer https://token.actions.githubusercontent.com \
  --cert-identity "https://github.com/zakkeown/MetalMom/.github/workflows/release.yml@refs/tags/v0.2.0"
```

## What the Release Workflow Does

1. Builds Swift package in release mode
2. Builds dylib and copies to Python package
3. Builds XCFramework (iOS device + iOS Simulator + macOS)
4. Zips XCFramework and computes SHA256 checksum
5. Builds Python wheel with correct macOS arm64 platform tag
6. Signs wheel and XCFramework with sigstore (keyless OIDC)
7. Generates release notes with git-cliff
8. Creates GitHub Release with all artifacts
9. Publishes to TestPyPI (RC tags) or PyPI (release tags)

## Version Sources

The bump script updates all of these:
- `pyproject.toml` — `version = "X.Y.Z"`
- `python/metalmom/__init__.py` — `__version__ = "X.Y.Z"`
- `docs/api/conf.py` — `release = "X.Y.Z"`
- `CHANGELOG.md` — generated by git-cliff

SPM version comes from the git tag (no file to update).

## Model Updates

Models are hosted separately on Hugging Face Hub:

```bash
# Upload or update models
python scripts/upload_models_hf.py --repo-id zkeown/metalmom-coreml-models
```
